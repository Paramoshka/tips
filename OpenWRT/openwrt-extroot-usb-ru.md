# –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ OpenWrt —Å –ø–æ–º–æ—â—å—é **Extroot** (USB/SD)

–≠—Ç–æ—Ç –≥–∞–π–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ä–∞–∑–¥–µ–ª `/overlay` –Ω–∞ —Ñ–ª–µ—à–∫—É/SD‚Äë–∫–∞—Ä—Ç—É (extroot), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Å—è—Ç–∫–∏ –≥–∏–≥–∞–±–∞–π—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è `opkg` –∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤.

> ‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ**: –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º **—É–Ω–∏—á—Ç–æ–∂–∞—é—Ç –¥–∞–Ω–Ω—ã–µ** –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –Ω–æ—Å–∏—Ç–µ–ª–µ. –î–µ–ª–∞–π—Ç–µ –ø–æ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ –∑–∞ —Ä–∞–∑. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –∏–º–µ–Ω–Ω–æ —Å –≤–∞—à–µ–π —Ñ–ª–µ—à–∫–æ–π (`/dev/sdX`).

---

## 0) –ß—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
- –†–æ—É—Ç–µ—Ä —Å USB/SD.
- –ß–∏—Å—Ç–∞—è —Ñ–ª–µ—à–∫–∞ (–ª—é–±–æ–≥–æ –æ–±—ä—ë–º–∞, 4‚Äì32 –ì–ë –±–æ–ª–µ–µ —á–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ).
- –î–æ—Å—Ç—É–ø –ø–æ SSH.
- –ü–∞–∫–µ—Ç—ã: `kmod-usb-storage`, `kmod-fs-ext4`, `block-mount`, `e2fsprogs`.  
  (–ò–Ω–æ–≥–¥–∞ —Ç–∞–∫–∂–µ `kmod-usb2` –∏/–∏–ª–∏ `kmod-usb3` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –∂–µ–ª–µ–∑–∞.)

–ï—Å–ª–∏ –º–µ—Å—Ç–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç–µ —á—Ç–æ‚Äë—Ç–æ –ª—ë–≥–∫–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–∏—à–Ω—é—é —Ç–µ–º—É/–ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é LuCI):
```sh
opkg remove --autoremove luci-theme-argon luci-i18n-*-*
```

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:
```sh
opkg update
opkg install kmod-usb-storage kmod-fs-ext4 block-mount e2fsprogs
# –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–≤–∞—à –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä):
opkg install kmod-usb2 kmod-usb3
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–ª–µ—à–∫–∞ –≤–∏–¥–Ω–∞:
```sh
dmesg | tail -n 50
block info
```

---

## 1) –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
```sh
sysupgrade -b /tmp/backup-$(date +%F).tar.gz
# —Å–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ —Å —Ä–æ—É—Ç–µ—Ä–∞ (scp/LuCI)
```

---

## 2) –†–∞–∑–º–µ—Ç–∫–∞ —Ñ–ª–µ—à–∫–∏ (MBR/DOS)
–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫—É—é MBR‚Äë—Ç–∞–±–ª–∏—Ü—É (—Å–æ–≤–º–µ—Å—Ç–∏–º–µ–µ –≤—Å–µ–≥–æ). **–ó–∞–º–µ–Ω–∏—Ç–µ `/dev/sda` –Ω–∞ –≤–∞—à –¥–∏—Å–∫!**
```sh
fdisk /dev/sda
# –≤–Ω—É—Ç—Ä–∏ fdisk:
#   o    (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é MBR/DOS —Ç–∞–±–ª–∏—Ü—É —Ä–∞–∑–¥–µ–ª–æ–≤)
#   n    (–Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª)
#   p    (primary)
#   1    (–Ω–æ–º–µ—Ä 1)
#   Enter (—Å—Ç–∞—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
#   Enter (–¥–æ –∫–æ–Ω—Ü–∞ –¥–∏—Å–∫–∞)
#   w    (–∑–∞–ø–∏—Å–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
```

–ï—Å–ª–∏ –≤–¥—Ä—É–≥ fdisk —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ ¬´–æ—Å—Ç–∞–ª—Å—è GPT/MBR¬ª, –º–æ–∂–Ω–æ –æ–±–Ω—É–ª–∏—Ç—å –Ω–∞—á–∞–ª–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å:
```sh
dd if=/dev/zero of=/dev/sda bs=1M count=4
```

---

## 3) –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (ext4) –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```sh
mkfs.ext4 -L overlay /dev/sda1
```

## 3.1) –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ
``` 
mkdir -p /mnt/usb
mount /dev/sda1 /mnt/usb
```

> üí° –í–º–µ—Å—Ç–æ ext4 –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å f2fs –Ω–∞ —Ñ–ª–µ—à–∫–∞—Ö (–ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è `kmod-fs-f2fs` –∏ `mkfs.f2fs`). –í –ø—Ä–∏–º–µ—Ä–µ ‚Äî ext4.

---

## 4) –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ `/overlay` –Ω–∞ —Ñ–ª–µ—à–∫—É
```sh
tar -C /overlay -cpf - . | tar -C /mnt/usb -xpf -
sync
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ñ–ª–µ—à–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ø–∏—Å–æ–∫ `/mnt/usb/etc`).

---

## 5) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∫ `/overlay`
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º fstab –∏ —É–∑–Ω–∞–µ–º UUID —Ñ–ª–µ—à–∫–∏:
```sh
block detect > /etc/config/fstab
block info | grep /dev/sda1

# –Ω–∞–¥—ë–∂–Ω–æ –≤—ã—Ç–∞—â–∏—Ç—å UUID –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:
UUID="$(block info | awk -F 'UUID=\"|\"' '/\/dev\/sda1/ {print $2}')"
echo "$UUID"
```

–î–æ–±–∞–≤–∏–º —Å–µ–∫—Ü–∏—é –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è `/overlay` —á–µ—Ä–µ–∑ UCI:
```sh
uci add fstab mount
uci set fstab.@mount[-1].target='/overlay'
uci set fstab.@mount[-1].uuid="$UUID"
uci set fstab.@mount[-1].fstype='ext4'
uci set fstab.@mount[-1].options='rw,noatime,nodiratime'
uci set fstab.@mount[-1].enabled='1'
uci commit fstab

# –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –§–° –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
uci set fstab.global.check_fs='1'
uci commit fstab
```

> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø–æ—Å–ª–µ `block detect` –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è —Å–µ–∫—Ü–∏—è `target '/mnt/usb'` —Å `enabled '0'` ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ú—ã –¥–æ–±–∞–≤–ª—è–µ–º **–Ω–æ–≤—É—é** —Å–µ–∫—Ü–∏—é –¥–ª—è `/overlay`.

---

## 6) –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
```sh
reboot
```

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å—ë –Ω–∞ –º–µ—Å—Ç–µ:
```sh
mount | grep overlay
df -hT
```
–î–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ—á—Ç–æ –≤—Ä–æ–¥–µ:
```
/dev/sda1 on /overlay type ext4 (...)
overlayfs:/overlay on / type overlay (...)
```
–ò —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ‚Äî –≥–∏–≥–∞–±–∞–π—Ç—ã.

---

## 7) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ (–ø—Ä–∏–º–µ—Ä —Å sing-box)
```sh
opkg update
opkg install sing-box-tiny

# –ø–æ –∂–µ–ª–∞–Ω–∏—é:
/etc/init.d/sing-box enable
/etc/init.d/sing-box start
sing-box version
```

–ï—Å–ª–∏ opkg –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª–æ–∂–∏—Ç –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ —Ä—è–¥–æ–º (c —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `-opkg`):
```text
/etc/config/sing-box-opkg
/etc/sing-box/config.json-opkg
```
‚Äî —Ä–µ—à–∏—Ç–µ: –æ—Å—Ç–∞–≤–∏—Ç—å —Å–≤–æ–∏, –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –Ω–æ–≤—ã–µ –∏–ª–∏ —Å–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (`diff -u ...`).

---

## 8) –¢—é–Ω–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ë–æ–ª—å—à–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏/–º–µ–Ω—å—à–µ –∏–∑–Ω–æ—Å–∞:
  ```sh
  # —É–±—Ä–∞—Ç—å 'sync' –∏ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç –æ—à–∏–±–æ–∫:
  idx="$(uci show fstab | awk -F'[][]' '/@mount\\[[0-9]+\\]\\.target='\''\\/overlay'\''/ {print $2; exit}')"
  uci set fstab.@mount[$idx].options='rw,noatime,nodiratime,errors=remount-ro'
  uci set fstab.global.check_fs='1'
  uci commit fstab
  reboot
  ```

- –†–µ–≥—É–ª—è—Ä–Ω—ã–π TRIM (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `fstrim`):
  ```sh
  opkg install fstrim
  echo '0 4 * * 1 fstrim -v /overlay' >> /etc/crontabs/root
  /etc/init.d/cron restart
  ```

- Swap‚Äë—Ñ–∞–π–ª (–µ—Å–ª–∏ –º–∞–ª–æ RAM):
  ```sh
  dd if=/dev/zero of=/overlay/swapfile bs=1M count=256
  chmod 600 /overlay/swapfile
  mkswap /overlay/swapfile
  swapon /overlay/swapfile
  # –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:
  uci add fstab swap
  uci set fstab.@swap[-1].enabled='1'
  uci set fstab.@swap[-1].device='/overlay/swapfile'
  uci commit fstab
  ```

---

## 9) –¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥
- **–ü–æ—Å–ª–µ —Ä–µ–±—É—Ç–∞ `/overlay` —Å–Ω–æ–≤–∞ –º–∞–ª–µ–Ω—å–∫–∏–π:** –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–¥—É–ª–µ–π –¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ —Å—Ç–∞—Ä—Ç–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–æ—è—Ç `kmod-usb-storage`, `kmod-fs-ext4`, `block-mount`, –∞ —Ç–∞–∫–∂–µ –Ω—É–∂–Ω—ã–µ `kmod-usb2/usb3`. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ `logread` –∏ `dmesg`.
- **–§–ª–µ—à–∫–∞ –Ω–µ –ø–∏—Ç–∞–µ—Ç—Å—è:** –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø–æ—Ä—Ç/–∫–æ—Ä–æ—Ç–∫–∏–π –∫–∞–±–µ–ª—å/–ø–∏—Ç–∞–µ–º—ã–π USB‚Äë—Ö–∞–±.
- **–í–¥—Ä—É–≥ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª—Å—è –æ—Ç–∫–∞—Ç:** –≤—ã–∫–ª—é—á–∏—Ç–µ —Ä–æ—É—Ç–µ—Ä, –∏–∑–≤–ª–µ–∫–∏—Ç–µ —Ñ–ª–µ—à–∫—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ—Å—å –±–µ–∑ –Ω–µ—ë ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π overlay. –î–∞–ª—å—à–µ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ `/etc/config/fstab` –∏–ª–∏ –ø–µ—Ä–µ—Å—Ç–∞–≤—å—Ç–µ extroot.

---

## 10) –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–¥–µ–ª–æ–≤ **MBR (DOS)** ‚Äî —Å–∞–º—ã–π —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –≤—ã–±–æ—Ä –¥–ª—è —Ñ–ª–µ—à–µ–∫. GPT (`gdisk`) —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤ –Ω—ë–º —á–∞—Å—Ç–æ –Ω–µ—Ç —Å–º—ã—Å–ª–∞.
- –í–º–µ—Å—Ç–æ ext4 –Ω–∞ —Ñ–ª–µ—à–∫–∞—Ö —á–∞—Å—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç **f2fs** ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –ø–æ—Ç—Ä–µ–±—É—é—Ç—Å—è —Å–≤–æ–∏ –º–æ–¥—É–ª–∏ –∏ —É—Ç–∏–ª–∏—Ç—ã.
- –î–µ–ª–∞–π—Ç–µ **–æ–¥–Ω—É** –∫–æ–º–∞–Ω–¥—É –∑–∞ —Ä–∞–∑ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—ã–≤–æ–¥ ‚Äî —ç—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å —Å—é—Ä–ø—Ä–∏–∑–æ–≤.

–£–¥–∞—á–∏! –¢–µ–ø–µ—Ä—å –Ω–∞ `/overlay` —É –≤–∞—Å –≥–∏–≥–∞–±–∞–π—Ç—ã —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ üöÄ
